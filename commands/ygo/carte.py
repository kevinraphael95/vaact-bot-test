# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“ ygo/carte.py â€” Commande !carte
# Objectif : Rechercher une carte Yu-Gi-Oh! dans plusieurs langues via l'API YGOPRODeck
# CatÃ©gorie : ğŸƒ Yu-Gi-Oh!
# AccÃ¨s : Public
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ IMPORTS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import discord
from discord.ext import commands
import aiohttp
import urllib.parse

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”§ Fonction utilitaire pour suggestions si carte non trouvÃ©e
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def chercher_suggestions(nom: str):
    """Recherche jusqu'Ã  5 cartes proches en multilingue si la carte exacte est introuvable."""
    suggestions = []
    langues = {"fr": "ğŸ‡«ğŸ‡·", "en": "ğŸ‡¬ğŸ‡§", "de": "ğŸ‡©ğŸ‡ª", "it": "ğŸ‡®ğŸ‡¹", "pt": "ğŸ‡µğŸ‡¹"}
    nom_encode = urllib.parse.quote(nom)

    async with aiohttp.ClientSession() as session:
        for code, flag in langues.items():
            url = f"https://db.ygoprodeck.com/api/v7/cardinfo.php?fname={nom_encode}&language={code}&num=5"
            async with session.get(url) as resp:
                if resp.status == 200:
                    data = await resp.json()
                    if "data" in data:
                        for carte in data["data"]:
                            suggestions.append((carte["name"], flag))
                if len(suggestions) >= 5:
                    break
    return suggestions[:5]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  COG : Carte
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Carte(commands.Cog):
    """
    ğŸ” Cog contenant la commande !carte permettant de chercher une carte
    Yu-Gi-Oh! dans plusieurs langues via l'API YGOPRODeck.
    """

    def __init__(self, bot: commands.Bot):
        self.bot = bot

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ COMMANDE : !carte / !card
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @commands.command(
        name="carte",
        aliases=["card"],
        help="ğŸ“„ Affiche les infos dâ€™une carte Yu-Gi-Oh! (FR, EN, DE, IT, PT)."
    )
    async def carte(self, ctx: commands.Context, *, nom: str):
        """
        ğŸ§  Commande !carte <nom>
        Recherche une carte Yu-Gi-Oh! par son nom (exact), et affiche ses infos.
        """

        nom_encode = urllib.parse.quote(nom)
        url = f"https://db.ygoprodeck.com/api/v7/cardinfo.php?name={nom_encode}&language=fr"

        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url) as resp:
                    if resp.status != 200:
                        await ctx.send("ğŸš¨ Impossible de contacter lâ€™API.")
                        return
                    data = await resp.json()

            if "data" not in data:
                suggestions = await chercher_suggestions(nom)
                if suggestions:
                    suggestion_txt = "\n".join(f"{flag} **{name}**" for name, flag in suggestions)
                    await ctx.send(
                        f"âŒ Carte introuvable en franÃ§ais. Voici quelques suggestions proches :\n{suggestion_txt}"
                    )
                else:
                    await ctx.send("âŒ Aucune carte trouvÃ©e. VÃ©rifie lâ€™orthographe ou essaie un autre nom.")
                return

            carte = data["data"][0]
            embed = discord.Embed(
                title=carte.get("name", "Carte inconnue"),
                description=carte.get("desc", "Pas de description disponible."),
                color=discord.Color.red()
            )

            embed.add_field(name="ğŸ§ª Type", value=carte.get("type", "?"), inline=True)

            if carte.get("type", "").lower().startswith("monstre"):
                atk = carte.get("atk", "?")
                defe = carte.get("def", "?")
                level = carte.get("level", "?")
                attr = carte.get("attribute", "?")
                race = carte.get("race", "?")

                embed.add_field(name="âš”ï¸ ATK / DEF", value=f"{atk} / {defe}", inline=True)
                embed.add_field(name="â­ Niveau / Rang", value=str(level), inline=True)
                embed.add_field(name="ğŸŒªï¸ Attribut", value=attr, inline=True)
                embed.add_field(name="ğŸ‘¹ Race", value=race, inline=True)

            embed.set_thumbnail(url=carte["card_images"][0]["image_url"])
            await ctx.send(embed=embed)

        except Exception as e:
            print(f"[ERREUR CARTE] {e}")
            await ctx.send("ğŸ’¥ Une erreur est survenue lors de la recherche de la carte.")

    def cog_load(self):
        self.carte.category = "ğŸƒ Yu-Gi-Oh!"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âš™ï¸ SETUP DU COG
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def setup(bot: commands.Bot):
    cog = Carte(bot)
    for command in cog.get_commands():
        command.category = "ğŸƒ Yu-Gi-Oh!"
    await bot.add_cog(cog)
    print("âœ… Cog chargÃ© : Carte (catÃ©gorie = ğŸƒ Yu-Gi-Oh!)")
